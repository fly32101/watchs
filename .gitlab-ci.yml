# GitLab CI/CD é…ç½®æ–‡ä»¶
# æ”¯æŒå¤šå¹³å°æž„å»ºå’Œè‡ªåŠ¨å‘å¸ƒ

# å®šä¹‰æž„å»ºé˜¶æ®µ
stages:
  - test
  - build
  - release

# å®šä¹‰å˜é‡
variables:
  GO_VERSION: "1.21"
  PACKAGE_NAME: "watchs"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}"

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .cache

# æµ‹è¯•é˜¶æ®µ
test:
  stage: test
  image: golang:${GO_VERSION}
  before_script:
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - export GOCACHE="$CI_PROJECT_DIR/.cache/build"
    - export GOMODCACHE="$CI_PROJECT_DIR/.cache/mod"
  script:
    - echo "Running tests..."
    - go version
    - go mod download
    - go vet ./...
    - go test -v ./...
    - go build -v ./cmd/watchs
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# æž„å»ºé˜¶æ®µ - ä»…åœ¨æŽ¨é€tagæ—¶æ‰§è¡Œ
build:
  stage: build
  image: golang:${GO_VERSION}
  before_script:
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - export GOCACHE="$CI_PROJECT_DIR/.cache/build"
    - export GOMODCACHE="$CI_PROJECT_DIR/.cache/mod"
    - apt-get update -qq && apt-get install -y -qq git curl
  script:
    - echo "Building for multiple platforms..."
    - mkdir -p dist
    
    # è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
    - export VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
    - export COMMIT=${CI_COMMIT_SHA}
    - export DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    - export LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}"
    
    # æž„å»º Linux AMD64
    - echo "Building Linux AMD64..."
    - GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-linux-amd64 ./cmd/watchs
    
    # æž„å»º Linux ARM64
    - echo "Building Linux ARM64..."
    - GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-linux-arm64 ./cmd/watchs
    
    # æž„å»º Windows AMD64
    - echo "Building Windows AMD64..."
    - GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-windows-amd64.exe ./cmd/watchs
    
    # æž„å»º macOS AMD64
    - echo "Building macOS AMD64..."
    - GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-darwin-amd64 ./cmd/watchs
    
    # æž„å»º macOS ARM64 (Apple Silicon)
    - echo "Building macOS ARM64..."
    - GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-darwin-arm64 ./cmd/watchs
    
    # ç”Ÿæˆæ ¡éªŒå’Œ
    - cd dist
    - sha256sum * > checksums.txt
    - cd ..
    
    # æ˜¾ç¤ºæž„å»ºç»“æžœ
    - echo "Build completed successfully!"
    - ls -la dist/
  artifacts:
    name: "${PACKAGE_NAME}-${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# å‘å¸ƒé˜¶æ®µ - åˆ›å»ºGitLab Release
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Creating GitLab release..."
    - export VERSION=${CI_COMMIT_TAG}
    
    # ä¸Šä¼ æž„å»ºäº§ç‰©åˆ°Package Registry
    - |
      for file in dist/*; do
        filename=$(basename "$file")
        echo "Uploading $filename..."
        curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
             --upload-file "$file" \
             "${PACKAGE_REGISTRY_URL}/${VERSION}/${filename}"
      done
    
    # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
    - |
      cat > release_notes.md << EOF
      ## Watchs ${VERSION}
      
      ### ðŸ“¦ ä¸‹è½½é“¾æŽ¥
      
      #### Linux
      - [Linux AMD64](${PACKAGE_REGISTRY_URL}/${VERSION}/${PACKAGE_NAME}-linux-amd64)
      - [Linux ARM64](${PACKAGE_REGISTRY_URL}/${VERSION}/${PACKAGE_NAME}-linux-arm64)
      
      #### Windows
      - [Windows AMD64](${PACKAGE_REGISTRY_URL}/${VERSION}/${PACKAGE_NAME}-windows-amd64.exe)
      
      #### macOS
      - [macOS Intel](${PACKAGE_REGISTRY_URL}/${VERSION}/${PACKAGE_NAME}-darwin-amd64)
      - [macOS Apple Silicon](${PACKAGE_REGISTRY_URL}/${VERSION}/${PACKAGE_NAME}-darwin-arm64)
      
      #### æ ¡éªŒå’Œ
      - [checksums.txt](${PACKAGE_REGISTRY_URL}/${VERSION}/checksums.txt)
      
      ### ðŸš€ å®‰è£…æ–¹æ³•
      
      ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œèµ‹äºˆæ‰§è¡Œæƒé™å³å¯ä½¿ç”¨ï¼š
      
      \`\`\`bash
      # Linux/macOS
      chmod +x ${PACKAGE_NAME}-*
      ./${PACKAGE_NAME}-* version
      
      # Windows
      ${PACKAGE_NAME}-windows-amd64.exe version
      \`\`\`
      
      ### ðŸ“ æ›´æ–°å†…å®¹
      
      è¯·æŸ¥çœ‹æäº¤åŽ†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
      EOF
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: './release_notes.md'
    tag_name: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Linux AMD64'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/${PACKAGE_NAME}-linux-amd64'
          link_type: 'package'
        - name: 'Linux ARM64'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/${PACKAGE_NAME}-linux-arm64'
          link_type: 'package'
        - name: 'Windows AMD64'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/${PACKAGE_NAME}-windows-amd64.exe'
          link_type: 'package'
        - name: 'macOS Intel'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/${PACKAGE_NAME}-darwin-amd64'
          link_type: 'package'
        - name: 'macOS Apple Silicon'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/${PACKAGE_NAME}-darwin-arm64'
          link_type: 'package'
        - name: 'Checksums'
          url: '${PACKAGE_REGISTRY_URL}/${CI_COMMIT_TAG}/checksums.txt'
          link_type: 'other'
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# æ‰‹åŠ¨æž„å»ºä»»åŠ¡ - å¯åœ¨GitLabç•Œé¢æ‰‹åŠ¨è§¦å‘
manual_build:
  stage: build
  image: golang:${GO_VERSION}
  before_script:
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - export GOCACHE="$CI_PROJECT_DIR/.cache/build"
    - export GOMODCACHE="$CI_PROJECT_DIR/.cache/mod"
  script:
    - echo "Manual build triggered..."
    - go mod download
    - mkdir -p dist
    - export VERSION="manual-${CI_COMMIT_SHORT_SHA}"
    - export LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${CI_COMMIT_SHA} -X main.date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
    - GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-linux-amd64 ./cmd/watchs
    - GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-windows-amd64.exe ./cmd/watchs
    - GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${PACKAGE_NAME}-darwin-amd64 ./cmd/watchs
    - ls -la dist/
  artifacts:
    name: "${PACKAGE_NAME}-manual-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/
    expire_in: 3 days
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH
